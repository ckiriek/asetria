# DevLog - 2025-11-10

## 22:45 UTC - Regulatory Data Agent Architecture Finalized

### What Changed
Выделил **Regulatory Data Agent** как отдельный, самостоятельный микросервис с особой зоной ответственности. Это критическое архитектурное решение, которое меняет структуру всей системы.

### Key Decisions

#### 1. Regulatory Data Agent = Отдельный компонент
**Было (6 агентов):**
```
Intake → [Data Enrichment внутри Composer] → Composer → Writer → Validator → Assembler
```

**Стало (7 агентов):**
```
Intake → Regulatory Data Agent → Composer → Writer → Validator → Assembler → Reviewer
```

**Почему это важно:**
- Единственный агент, который ходит наружу (external API calls)
- Работает с публичными регуляторными данными (не PHI/PII)
- Имеет собственный слой кэширования и версионирования
- Критичен для Generic и Hybrid режимов
- Опционален для Innovator режима

#### 2. Когда Regulatory Data Agent активируется

| Тип продукта | Regulatory Data Agent | Почему |
|--------------|----------------------|--------|
| **Innovator** | ❌ опционально | Все данные от спонсора |
| **Generic** | ✅ **обязательно** | Основной источник — публичные регистры |
| **Hybrid** | ✅ частично | Nonclinical из регистров, clinical из загрузок |
| **Post-marketing** | ✅ опционально | FAERS / EudraVigilance данные |

### Documents Created

#### 1. REGULATORY_DATA_AGENT_SPEC.md
Полная техническая спецификация:
- API endpoints (5 endpoints)
- Source adapters (9 адаптеров: FDA, EMA, PubMed, ClinicalTrials, etc.)
- Regulatory Data Layer (database schema)
- Data Validator (rules and scoring)
- Caching strategy (Redis + Postgres)
- Error handling (7 error codes)
- Metrics & monitoring
- Implementation plan (4 sprints)

#### 2. DATA_CONTRACTS_REGULATORY.md
Стандартизированные контракты данных:
- **labels.sections** (FDA/EMA labels normalized)
- **adverse_events** (MedDRA normalized)
- **clinical_pharmacology** (PK/PD data)
- **efficacy_data** (clinical outcomes)
- **DTO для Composer Agent**
- **DTO для Writer Agent**
- **Provenance & Confidence tracking**
- **Manifest format** (audit trail)
- **Validation rules**
- **Chart specifications**

#### 3. IB_SECTION_TEMPLATES_EXAMPLES.md
Эталонные примеры разделов IB (submission-ready):
- **Section 5: Clinical Pharmacology**
  - 5.1 Mechanism of Action
  - 5.2 Pharmacokinetics (с таблицей PK parameters)
  - 5.3 Dose-Response (с графиком Emax)
  - 5.4 Drug-Drug Interactions
  - 5.5 Summary
- **Section 6: Safety and Tolerability**
  - 6.1 Overall Safety Profile
  - 6.2 TEAEs (с таблицей по PT)
  - 6.3 SAEs (с таблицей serious events)
  - 6.4 Postmarketing Data
  - 6.5 AESI
  - 6.6 Special Populations
  - 6.7 Lab Findings
  - 6.8 Summary
- **Section 7: Efficacy and Clinical Outcomes**
  - 7.1 Overview
  - 7.2 Phase 2 Studies (с таблицей dose-ranging)
  - 7.3 Phase 3 Study (с таблицей endpoints)
  - 7.4 Secondary Outcomes
  - 7.5 Subgroup Analyses
  - 7.6 Comparative Efficacy
  - 7.7 Summary

### Architecture Updates

#### Updated ASETRIA_WRITER_IMPLEMENTATION_PLAN.md
- Изменено с 6 на 7 агентов
- Обновлён pipeline: добавлен Regulatory Data Agent между Intake и Composer
- Добавлено упоминание provenance tracking

### Technical Details

#### Source Adapters (9 адаптеров)
1. **OpenFDA** → labels.sections, adverse_events
2. **Drugs@FDA** → clinical/nonclinical summaries
3. **DailyMed** → labels (conflict resolution: newer wins)
4. **EMA EPAR** → nonclinical/clinical overviews
5. **ClinicalTrials.gov** → trials, efficacy data
6. **PubChem** → inchikey, chemical properties
7. **PubMed** → literature, references
8. **Orange Book** → RLD, TE-codes
9. **MHRA PAR** → EU/UK regulatory data

#### Data Flow
```
External Sources (FDA/EMA/PubMed)
    ↓
[Source Adapters] — fetch raw data
    ↓
[Normalizer] — convert to standard schema
    ↓
[Deduper & Resolver] — remove conflicts
    ↓
[Data Validator] — check quality, score coverage
    ↓
[Regulatory Data Layer] — store in Postgres + Redis cache
    ↓
[Snapshot API] — serve to Composer/Writer/Validator
```

#### Normalization Keys
- **Primary key:** `inchikey` (canonical compound identifier)
- **Product key:** `application_number` + `region`
- **Provenance:** Every field tracks source, URL, date, confidence
- **Conflict resolution:** Priority by source type and freshness

#### Caching Strategy
**Redis (Hot Keys):**
- Labels: TTL 7 дней
- RLD info: TTL 30 дней
- TE-коды: TTL 30 дней
- InChIKey map: TTL 30 дней

**Updates:**
- Nightly sync job для обновлений
- On-demand refresh при первом проекте по веществу

#### Error Handling
**Codes:**
- E101_ENRICH_TIMEOUT
- E102_SOURCE_RATE_LIMIT
- E301_IDENTITY_UNRESOLVED (no inchikey)
- E401_TE_CODE_MISSING_FOR_GENERIC
- E402_RLD_NOT_FOUND
- E501_MEDDRA_TAXONOMY_MISSING

**Strategy:** Best effort — partial fail не роняет enrichment

### Implementation Plan

**Sprint 1 (Week 4-5):**
- PubChem resolver
- openFDA adapter
- DailyMed adapter
- Orange Book adapter
- Базовая схема
- Snapshot API

**Sprint 2 (Week 5-6):**
- EMA EPAR parser
- ClinicalTrials adapter
- Literature via PubMed
- Deduper & Resolver

**Sprint 3 (Week 6-7):**
- MedDRA маппинг
- Validator rules
- Coverage scoring
- Manifest и provenance

**Sprint 4 (Week 7-8):**
- Retries, Circuit breaker
- Cache layer
- Metrics и алерты

### What's Next

#### Immediate (Week 1):
1. Финализировать architecture decisions
2. Добавить product type selection в UI
3. Создать первые migrations (compounds, products)
4. Построить Intake Agent prototype

#### Week 2-4:
1. Имплементировать Regulatory Data Layer (database schema)
2. Создать первый адаптер (openFDA)
3. Построить Snapshot API
4. Тестировать с Metformin как test case

### Key Insights

1. **Data First, AI Second**
   - Нормализованные данные = foundation
   - LLM пишет narrative вокруг фактов
   - Нет галлюцинаций если данные структурированы

2. **Regulatory Data Agent = Competitive Advantage**
   - Generic mode = 80% меньше ввода данных
   - External enrichment = автоматизация
   - Один пайплайн, разные шаблоны

3. **Provenance = Compliance**
   - Каждое поле знает свой источник
   - Audit trail для регуляторов
   - Версионирование для воспроизводимости

4. **Quality by Validation**
   - Coverage scoring (nonclinical/clinical/label)
   - Automated compliance checks
   - Human review для финальных 10%

### Files Modified
- `ASETRIA_WRITER_IMPLEMENTATION_PLAN.md` (updated agent count, pipeline)

### Files Created
- `REGULATORY_DATA_AGENT_SPEC.md` (full technical spec)
- `DATA_CONTRACTS_REGULATORY.md` (data contracts)
- `IB_SECTION_TEMPLATES_EXAMPLES.md` (reference examples)
- `devlog/2025-11-10.md` (this file)

---

**Status:** ✅ Architecture Updated — Regulatory Data Agent as Standalone Component

**Next Session:** Begin Phase 0 implementation (Week 1 action plan)

**Confidence:** High — clear separation of concerns, well-defined contracts
